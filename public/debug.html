<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Homies Chat - Debug Mode</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/dm-friends.css">
    <link rel="stylesheet" href="css/friends.css">
    <link rel="stylesheet" href="css/app-icon.css">
    <link rel="icon" href="assets/favicon.ico" type="image/x-icon">
    <style>
        /* Critical overrides to force visibility */
        body {
            overflow: auto !important;
            background-color: #1a2633 !important;
        }
        
        #chat-container {
            display: grid !important;
            grid-template-columns: 280px 1fr !important;
            grid-template-areas: "sidebar content" !important;
            height: 100vh !important;
            width: 100% !important;
            background-color: #1a2633 !important;
            position: relative !important;
            z-index: 10 !important;
            opacity: 1 !important;
            visibility: visible !important;
            pointer-events: auto !important;
        }
        
        #left-sidebar {
            grid-area: sidebar !important;
            display: flex !important;
            flex-direction: column !important;
            background-color: #1a2633 !important;
            height: 100vh !important;
            opacity: 1 !important;
            visibility: visible !important;
            pointer-events: auto !important;
            z-index: 20 !important;
        }
        
        #main-content {
            grid-area: content !important;
            display: flex !important;
            flex-direction: column !important;
            background-color: #121212 !important;
            height: 100vh !important;
            opacity: 1 !important;
            visibility: visible !important;
            pointer-events: auto !important;
            z-index: 20 !important;
        }
        
        /* Hide all auth screens */
        #auth-container, .login-container, #login-container {
            display: none !important;
            opacity: 0 !important;
            visibility: hidden !important;
            pointer-events: none !important;
            z-index: -1 !important;
        }
        
        /* Make sure elements are clickable */
        button, a, input, textarea {
            pointer-events: auto !important;
            cursor: pointer !important;
        }
        
        /* Force showing chat components */
        #messages-container, #message-input-area, #chat-header {
            display: flex !important;
            opacity: 1 !important;
            visibility: visible !important;
        }
        
        /* Fix message styling */
        .message {
            display: flex;
            align-items: flex-start;
            margin-bottom: 16px;
            padding: 4px 20px;
            transition: background-color 0.2s;
        }
        
        .message:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }
        
        .message-avatar {
            width: 40px;
            height: 40px;
            min-width: 40px;
            margin-right: 16px;
            border-radius: 50%;
            overflow: hidden;
        }
        
        .message-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .message-content {
            flex: 1;
            min-width: 0;
        }
        
        .message-header {
            display: flex;
            align-items: center;
            margin-bottom: 4px;
        }
        
        .message-author {
            font-weight: 600;
            margin-right: 8px;
            color: var(--primary-color);
        }
        
        .message-timestamp {
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        
        .message-text {
            color: var(--text-light);
            word-break: break-word;
            line-height: 1.4;
        }
        
        /* Fix messages container */
        #messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px 0;
            display: flex !important;
            flex-direction: column !important;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- Main App - Discord Layout -->
        <div id="chat-container" style="display: grid !important;">
            
            <!-- Left Sidebar -->
            <div id="left-sidebar" style="display: flex !important;">
                <!-- App Logo -->
                <div class="app-logo">
                    <img src="https://cdn.glitch.global/2ac452ce-4fe9-49bc-bef8-47241df17d07/default%20pic.png?v=1747408645553" alt="The Homies Chat" class="app-icon">
                    <span>The Homies Chat</span>
                </div>
                
                <!-- Main Navigation -->
                <div class="main-nav">
                    <button class="nav-button active" id="home-button" title="Home">
                        <i class="bi bi-house-fill"></i>
                        <span>Home</span>
                    </button>
                    <button class="nav-button" id="dm-button" title="Direct Messages">
                        <i class="bi bi-chat-fill"></i>
                        <span>DMs</span>
                    </button>
                </div>
                
                <!-- Channels Section -->
                <div id="channels-section">
                    <div class="section-header">
                        <span>CHANNELS</span>
                        <button id="add-channel-btn" class="btn-icon" title="Add Channel">
                            <i class="bi bi-plus-lg"></i>
                        </button>
                    </div>
                    <div id="channels-list" class="list-container">
                        <div class="list-item active" data-channel="general">
                            <i class="bi bi-hash"></i>
                            <span>general</span>
                        </div>
                        <div class="list-item" data-channel="announcements">
                            <i class="bi bi-hash"></i>
                            <span>announcements</span>
                        </div>
                        <div class="list-item" data-channel="memes">
                            <i class="bi bi-hash"></i>
                            <span>memes</span>
                        </div>
                    </div>
                </div>
                
                <!-- User Profile Area -->
                <div class="user-profile-area">
                    <div class="user-avatar">
                        <img src="https://cdn.glitch.global/2ac452ce-4fe9-49bc-bef8-47241df17d07/default%20pic.png?v=1744642336378" alt="Your Avatar">
                        <div class="user-status online"></div>
                    </div>
                    <div class="user-details">
                        <div class="user-name" id="current-user">Etherwolf</div>
                    </div>
                    <div class="user-controls">
                        <button class="user-control-button" id="settings-button" title="Settings">
                            <i class="bi bi-gear-fill"></i>
                        </button>
                        <button class="user-control-button" id="logout-btn" title="Logout">
                            <i class="bi bi-box-arrow-right"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Main Content Area (Right) -->
            <div id="main-content" style="display: flex !important;">
                <!-- Chat Header -->
                <div id="chat-header">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-hash me-2"></i>
                        <span class="fw-bold" id="chat-title">general</span>
                    </div>
                    <div class="header-controls">
                        <!-- Video call button removed as requested -->
                    </div>
                </div>

                <!-- Messages Container -->
                <div id="messages-container">
                    <!-- Messages will be loaded here by JS -->
                    <div class="date-separator">
                        <span>Today</span>
                    </div>
                    <div class="system-message">
                        Welcome to the beginning of #general
                    </div>
                    <!-- Debug message -->
                    <div class="message">
                        <div class="message-avatar">
                            <img src="https://cdn.glitch.global/2ac452ce-4fe9-49bc-bef8-47241df17d07/default%20pic.png?v=1746110048911" alt="System">
                        </div>
                        <div class="message-content">
                            <div class="message-header">
                                <span class="message-author">System</span>
                                <span class="message-timestamp">Just now</span>
                            </div>
                            <div class="message-text">
                                Debug mode active. This is a special debug version to help fix display issues.
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Message Input Area -->
                <div id="message-input-area">
                    <div class="message-input-container">
                        <div class="input-wrapper">
                            <textarea id="message-input" placeholder="Message #general" rows="1"></textarea>
                        </div>
                        <div class="message-controls">
                            <button class="message-control-button" id="emoji-button" title="Add Emoji">
                                <i class="bi bi-emoji-smile"></i>
                            </button>
                            <button class="message-control-button" id="attach-file-button" title="Attach File">
                                <i class="bi bi-paperclip"></i>
                            </button>
                            <button id="send-button" title="Send Message">
                                <i class="bi bi-send-fill"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <!-- Third-party libraries -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

    <!-- Authentication scripts -->
    <script>
        // Check for existing authentication or perform login
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Debug mode active - checking authentication');
            
            // Display loading message while we check auth
            const body = document.body;
            const loadingOverlay = document.createElement('div');
            loadingOverlay.id = 'loading-overlay';
            loadingOverlay.style.position = 'fixed';
            loadingOverlay.style.top = '0';
            loadingOverlay.style.left = '0';
            loadingOverlay.style.width = '100%';
            loadingOverlay.style.height = '100%';
            loadingOverlay.style.backgroundColor = 'rgba(0,0,0,0.8)';
            loadingOverlay.style.display = 'flex';
            loadingOverlay.style.justifyContent = 'center';
            loadingOverlay.style.alignItems = 'center';
            loadingOverlay.style.zIndex = '9999';
            loadingOverlay.style.flexDirection = 'column';
            loadingOverlay.innerHTML = `
                <h2 style="color: white; margin-bottom: 20px;">Initializing Debug Mode...</h2>
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p id="loading-message" style="color: white; margin-top: 20px;">Checking authentication...</p>
            `;
            body.appendChild(loadingOverlay);
            
            // Function to update loading message
            function updateLoadingMessage(message) {
                document.getElementById('loading-message').textContent = message;
            }
            
            // Check for existing auth in localStorage
            const storedUser = localStorage.getItem('user');
            const authToken = localStorage.getItem('auth_token');
            
            if (storedUser && authToken) {
                try {
                    const user = JSON.parse(storedUser);
                    
                    // Clear stored authentication if this is a fresh debug session
                    if (window.location.href.includes('?clear=true')) {
                        localStorage.removeItem('user');
                        localStorage.removeItem('auth_token');
                        throw new Error('Clearing stored authentication');
                    }
                    
                    console.log('Found stored authentication', user.username);
                    updateLoadingMessage(`Found stored authentication for ${user.username}`);
                    
                    // Create socket connection with auth
                    window.socket = io({
                        auth: {
                            token: authToken,
                            userData: user
                        },
                        query: {
                            token: authToken,
                            userId: user.id || '',
                            username: user.username || ''
                        }
                    });
                    
                    // Listen for socket connection
                    window.socket.on('connect', function() {
                        console.log('Socket connected, registering session');
                        updateLoadingMessage('Socket connected, initializing interface...');
                        
                        // Register session
                        window.socket.emit('register-session', user);
                        
                        // Show the chat interface
                        setTimeout(() => {
                            initDebugInterface(user);
                            loadingOverlay.remove();
                        }, 1000);
                    });
                    
                    // Handle connection error
                    window.socket.on('connect_error', function(error) {
                        console.error('Socket connection error:', error);
                        updateLoadingMessage('Connection error, falling back to debug mode...');
                        
                        // Show interface anyway after delay
                        setTimeout(() => {
                            initDebugInterface(user);
                            loadingOverlay.remove();
                        }, 2000);
                    });
                } catch (e) {
                    console.error('Error parsing stored user:', e);
                    showLoginForm();
                }
            } else {
                // No stored authentication, show login form
                updateLoadingMessage('No stored authentication, please log in');
                setTimeout(() => {
                    showLoginForm();
                }, 1000);
            }
            
            // Function to show login form
            function showLoginForm() {
                loadingOverlay.remove();
                
                // Create login form overlay
                const loginOverlay = document.createElement('div');
                loginOverlay.id = 'login-overlay';
                loginOverlay.style.position = 'fixed';
                loginOverlay.style.top = '0';
                loginOverlay.style.left = '0';
                loginOverlay.style.width = '100%';
                loginOverlay.style.height = '100%';
                loginOverlay.style.backgroundColor = 'rgba(0,0,0,0.8)';
                loginOverlay.style.display = 'flex';
                loginOverlay.style.justifyContent = 'center';
                loginOverlay.style.alignItems = 'center';
                loginOverlay.style.zIndex = '9999';
                
                loginOverlay.innerHTML = `
                    <div class="card" style="width: 400px;">
                        <div class="card-header bg-primary text-white text-center">
                            <h4>Debug Mode Login</h4>
                        </div>
                        <div class="card-body">
                            <form id="debug-login-form">
                                <div class="mb-3">
                                    <label for="username" class="form-label">Username</label>
                                    <input type="text" class="form-control" id="username" placeholder="Enter your username">
                                </div>
                                <div class="mb-3">
                                    <label for="password" class="form-label">Password</label>
                                    <input type="password" class="form-control" id="password" placeholder="Enter your password">
                                </div>
                                <div class="mb-3">
                                    <label for="avatar-url" class="form-label">Avatar URL (optional)</label>
                                    <input type="text" class="form-control" id="avatar-url" placeholder="URL to your avatar image">
                                    <div class="form-text">Leave blank to use default avatar</div>
                                </div>
                                <div id="login-error" class="alert alert-danger d-none"></div>
                                <button type="submit" class="btn btn-primary w-100">Login</button>
                            </form>
                        </div>
                    </div>
                `;
                
                body.appendChild(loginOverlay);
                
                // Set up login form submission
                document.getElementById('debug-login-form').addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const username = document.getElementById('username').value;
                    const password = document.getElementById('password').value;
                    
                    if (!username || !password) {
                        showLoginError('Username and password are required');
                        return;
                    }
                    
                    // Show loading message
                    document.querySelector('#debug-login-form button').innerHTML = `
                        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                        Logging in...
                    `;
                    
                    const avatarUrl = document.getElementById('avatar-url').value.trim();
                    
                    // Attempt login
                    fetch('/api/auth/signin', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ username, password }),
                        credentials: 'include'
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.ok && data.user) {
                            // Add avatar URL if provided
                            if (avatarUrl) {
                                data.user.avatarUrl = avatarUrl;
                                data.user.avatar_url = avatarUrl;
                            }
                            
                            // Store authentication
                            localStorage.setItem('user', JSON.stringify(data.user));
                            localStorage.setItem('auth_token', data.token || '');
                            
                            // Create socket connection
                            window.socket = io({
                                auth: {
                                    token: data.token || '',
                                    userData: data.user
                                },
                                query: {
                                    token: data.token || '',
                                    userId: data.user.id || '',
                                    username: data.user.username || ''
                                }
                            });
                            
                            // Register session
                            window.socket.emit('register-session', data.user);
                            
                            // Remove login overlay and show interface
                            loginOverlay.remove();
                            initDebugInterface(data.user);
                        } else {
                            showLoginError(data.error || 'Login failed');
                            document.querySelector('#debug-login-form button').textContent = 'Login';
                        }
                    })
                    .catch(error => {
                        console.error('Login error:', error);
                        showLoginError('An error occurred during login');
                        document.querySelector('#debug-login-form button').textContent = 'Login';
                    });
                });
                
                // Helper to show login errors
                function showLoginError(message) {
                    const errorElement = document.getElementById('login-error');
                    errorElement.textContent = message;
                    errorElement.classList.remove('d-none');
                }
            }
        });
        
        // Function to initialize the debug interface
        function initDebugInterface(user) {
            console.log('Initializing debug interface for user:', user.username);
            
            // Make sure chat container is visible
            const chatContainer = document.getElementById('chat-container');
            if (chatContainer) {
                chatContainer.style.display = 'grid';
                chatContainer.style.opacity = '1';
                chatContainer.style.visibility = 'visible';
            }
            
            // Update user display
            const currentUserEl = document.getElementById('current-user');
            if (currentUserEl && user.username) {
                currentUserEl.textContent = user.username;
            }
            
            // Load message history
            loadMessageHistory();
            
            // Setup channel switching
            const channelItems = document.querySelectorAll('#channels-list .list-item');
            channelItems.forEach(item => {
                item.addEventListener('click', function() {
                    // Update active channel UI
                    channelItems.forEach(chan => chan.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Update chat title
                    const channelName = this.getAttribute('data-channel');
                    document.getElementById('chat-title').textContent = channelName;
                    
                    // Update message input placeholder
                    document.getElementById('message-input').placeholder = `Message #${channelName}`;
                    
                    // Load messages for the selected channel
                    loadMessageHistory(channelName);
                });
            });
            
            // Setup send button
            const sendButton = document.getElementById('send-button');
            const messageInput = document.getElementById('message-input');
            const messagesContainer = document.getElementById('messages-container');
            
            if (sendButton && messageInput && messagesContainer) {
                sendButton.addEventListener('click', function() {
                    const messageText = messageInput.value.trim();
                    if (messageText) {
                        // Create simple message element
                        const messageEl = document.createElement('div');
                        messageEl.className = 'message own-message';
                        messageEl.innerHTML = `
                            <div class="message-avatar">
                                <img src="https://cdn.glitch.global/2ac452ce-4fe9-49bc-bef8-47241df17d07/default%20pic.png?v=1746110048911" alt="You">
                            </div>
                            <div class="message-content">
                                <div class="message-header">
                                    <span class="message-author">${user.username}</span>
                                    <span class="message-timestamp">Just now</span>
                                </div>
                                <div class="message-text">
                                    ${messageText}
                                </div>
                            </div>
                        `;
                        
                        messagesContainer.appendChild(messageEl);
                        messageInput.value = '';
                        
                        // Scroll to bottom
                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                        
                        // If socket is connected, send message
                        if (window.socket && window.socket.connected) {
                            const activeChannel = document.querySelector('#channels-list .list-item.active');
                            const channelName = activeChannel ? activeChannel.getAttribute('data-channel') : 'general';
                            
                            window.socket.emit('message', {
                                content: messageText,
                                channel: '#' + channelName,
                                sender: user.username,
                                timestamp: new Date().toISOString()
                            });
                        }
                    }
                });
                
                // Allow Enter key to send message
                messageInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendButton.click();
                    }
                });
            }
            
            // Set up emoji button to show a simple message
            const emojiButton = document.getElementById('emoji-button');
            if (emojiButton) {
                emojiButton.addEventListener('click', function() {
                    alert('Emoji picker is disabled in debug mode');
                });
            }
            
            // Set up settings button to show a simple message
            const settingsButton = document.getElementById('settings-button');
            if (settingsButton) {
                settingsButton.addEventListener('click', function() {
                    alert('Settings are disabled in debug mode');
                });
            }
            
            // Set up logout button
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', function() {
                    if (confirm('Are you sure you want to log out?')) {
                        localStorage.removeItem('user');
                        localStorage.removeItem('auth_token');
                        window.location.reload();
                    }
                });
            }
            
            // Set up socket message listeners
            if (window.socket) {
                // Clean up any existing listeners to prevent duplicates
                window.socket.off('message');
                window.socket.off('message-history');
                
                window.socket.on('message', function(message) {
                    console.log('Received new message:', message);
                    addMessageToUI(message);
                    
                    // Add to local storage for backup
                    try {
                        const activeChannel = document.querySelector('#channels-list .list-item.active');
                        const channelName = activeChannel ? activeChannel.getAttribute('data-channel') : 'general';
                        const key = 'messages_' + channelName;
                        const storedMessages = JSON.parse(localStorage.getItem(key) || '[]');
                        storedMessages.push(message);
                        localStorage.setItem(key, JSON.stringify(storedMessages));
                    } catch (e) {
                        console.error('Error updating local storage with new message:', e);
                    }
                });
                
                window.socket.on('message-history', function(messages) {
                    console.log('Received message history:', messages ? messages.length : 0, 'messages');
                    displayMessageHistory(messages);
                });
                
                // Handle supabase messages separately if available
                window.socket.on('supabase-messages', function(messages) {
                    console.log('Received Supabase messages:', messages ? messages.length : 0, 'messages');
                    displayMessageHistory(messages);
                });
            }
        }
        
        // Function to load message history
        function loadMessageHistory(channel = 'general') {
            const messagesContainer = document.getElementById('messages-container');
            if (!messagesContainer) return;
            
            // Clear existing messages except the welcome message
            const welcomeMessage = messagesContainer.querySelector('.system-message:first-of-type');
            const dateSeparator = messagesContainer.querySelector('.date-separator:first-of-type');
            messagesContainer.innerHTML = '';
            
            if (dateSeparator) messagesContainer.appendChild(dateSeparator.cloneNode(true));
            if (welcomeMessage) messagesContainer.appendChild(welcomeMessage.cloneNode(true));
            
            // Add loading indicator with ID so we can remove it later
            const loadingId = 'loading-message-' + Date.now();
            const loadingMsg = document.createElement('div');
            loadingMsg.id = loadingId;
            loadingMsg.className = 'system-message';
            loadingMsg.textContent = 'Loading messages...';
            messagesContainer.appendChild(loadingMsg);
            
            // Request message history from server
            if (window.socket && window.socket.connected) {
                console.log('Requesting message history for channel:', channel);
                window.socket.emit('get-message-history', { channel: '#' + channel });
                
                // Set timeout to remove loading message if no response
                setTimeout(() => {
                    const loadingElement = document.getElementById(loadingId);
                    if (loadingElement) {
                        // Try to load from local storage if available
                        const localMessages = getLocalMessages(channel);
                        if (localMessages && localMessages.length > 0) {
                            loadingElement.textContent = 'Loaded messages from local storage';
                            setTimeout(() => loadingElement.remove(), 1000);
                            displayMessageHistory(localMessages);
                        } else {
                            loadingElement.textContent = 'No messages available for this channel';
                            setTimeout(() => loadingElement.remove(), 2000);
                        }
                    }
                }, 5000);
            } else {
                // If socket not connected, try local storage
                const localMessages = getLocalMessages(channel);
                if (localMessages && localMessages.length > 0) {
                    loadingMsg.textContent = 'Loaded messages from local storage';
                    setTimeout(() => loadingMsg.remove(), 1000);
                    displayMessageHistory(localMessages);
                } else {
                    // If socket not connected, show error
                    loadingMsg.textContent = 'Cannot load messages: Socket disconnected';
                    setTimeout(() => loadingMsg.remove(), 3000);
                }
            }
        }
        
        // Function to get messages from local storage
        function getLocalMessages(channel) {
            try {
                const key = 'messages_' + channel;
                const storedMessages = localStorage.getItem(key);
                return storedMessages ? JSON.parse(storedMessages) : [];
            } catch (e) {
                console.error('Error reading local messages:', e);
                return [];
            }
        }
        
        // Function to display message history
        function displayMessageHistory(messages) {
            const messagesContainer = document.getElementById('messages-container');
            if (!messagesContainer) return;
            
            // Remove loading message if present
            const loadingMessages = messagesContainer.querySelectorAll('[id^="loading-message-"]');
            loadingMessages.forEach(msg => msg.remove());
            
            // Check if we have messages
            if (!messages || messages.length === 0) {
                const noMessagesEl = document.createElement('div');
                noMessagesEl.className = 'system-message';
                noMessagesEl.textContent = 'No messages in this channel yet. Start the conversation!';
                messagesContainer.appendChild(noMessagesEl);
                return;
            }
            
            // Save to local storage for backup
            try {
                const activeChannel = document.querySelector('#channels-list .list-item.active');
                const channelName = activeChannel ? activeChannel.getAttribute('data-channel') : 'general';
                localStorage.setItem('messages_' + channelName, JSON.stringify(messages));
            } catch (e) {
                console.error('Error saving messages to local storage:', e);
            }
            
            // Sort messages by timestamp
            const sortedMessages = messages.sort((a, b) => {
                return new Date(a.timestamp || a.created_at) - new Date(b.timestamp || b.created_at);
            });
            
            // Display each message
            sortedMessages.forEach(message => {
                addMessageToUI(message, false);
            });
            
            // Scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        // Function to add a message to the UI
        function addMessageToUI(message, scrollToBottom = true) {
            const messagesContainer = document.getElementById('messages-container');
            if (!messagesContainer) return;
            
            // Skip if message is deleted or invalid
            if (message.is_deleted || !message.content) return;
            
            // Create message element
            const messageEl = document.createElement('div');
            messageEl.className = 'message';
            messageEl.dataset.messageId = message.id || Date.now() + Math.random().toString(36).substring(2, 9);
            
            // Check if message already exists to avoid duplicates
            const existingMessage = messagesContainer.querySelector(`[data-message-id="${messageEl.dataset.messageId}"]`);
            if (existingMessage) {
                return; // Skip if already displayed
            }
            
            // Check if this is the current user's message
            const storedUser = localStorage.getItem('user');
            let currentUser = null;
            try {
                currentUser = JSON.parse(storedUser);
            } catch (e) {}
            
            const isOwnMessage = currentUser && 
                (message.sender === currentUser.username || 
                 message.sender_id === currentUser.id || 
                 message.sender_id === currentUser.userId);
                 
            if (isOwnMessage) {
                messageEl.classList.add('own-message');
            }
            
            // Format timestamp
            const timestamp = message.timestamp || message.created_at || new Date().toISOString();
            const formattedTime = formatTimestamp(timestamp);
            
            // Get avatar URL - try to use the user's avatar if available
            let avatarUrl = 'https://cdn.glitch.global/2ac452ce-4fe9-49bc-bef8-47241df17d07/default%20pic.png?v=1746110048911';
            
            // For own messages, use the current user's avatar
            if (isOwnMessage && currentUser) {
                avatarUrl = currentUser.avatarUrl || 
                           currentUser.avatar_url || 
                           'https://cdn.glitch.global/2ac452ce-4fe9-49bc-bef8-47241df17d07/default%20pic.png?v=1746110048911';
            }
            
            // Set message content
            messageEl.innerHTML = `
                <div class="message-avatar">
                    <img src="${avatarUrl}" alt="${message.sender || 'User'}">
                </div>
                <div class="message-content">
                    <div class="message-header">
                        <span class="message-author">${message.sender || 'User'}</span>
                        <span class="message-timestamp">${formattedTime}</span>
                    </div>
                    <div class="message-text">${message.content}</div>
                </div>
            `;
            
            // Add to container
            messagesContainer.appendChild(messageEl);
            
            // Scroll to bottom if needed
            if (scrollToBottom) {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
        }
        
        // Helper function to format timestamps
        function formatTimestamp(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const isToday = date.toDateString() === now.toDateString();
            
            if (isToday) {
                return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            } else {
                return date.toLocaleDateString([], { month: 'short', day: 'numeric' }) + 
                       ' at ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            }
        }
    </script>
</body>
</html>
