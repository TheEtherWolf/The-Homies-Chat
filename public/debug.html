<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Homies Chat - Debug Mode</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/dm-friends.css">
    <link rel="stylesheet" href="css/friends.css">
    <link rel="stylesheet" href="css/app-icon.css">
    <link rel="icon" href="favicon.png" type="image/png">
    <style>
        /* Critical overrides to force visibility */
        body {
            overflow: auto !important;
            background-color: #1a2633 !important;
        }
        
        #chat-container {
            display: grid !important;
            grid-template-columns: 280px 1fr !important;
            grid-template-areas: "sidebar content" !important;
            height: 100vh !important;
            width: 100% !important;
            background-color: #1a2633 !important;
            position: relative !important;
            z-index: 10 !important;
            opacity: 1 !important;
            visibility: visible !important;
            pointer-events: auto !important;
        }
        
        #left-sidebar {
            grid-area: sidebar !important;
            display: flex !important;
            flex-direction: column !important;
            background-color: #1a2633 !important;
            height: 100vh !important;
            opacity: 1 !important;
            visibility: visible !important;
            pointer-events: auto !important;
            z-index: 20 !important;
        }
        
        #main-content {
            grid-area: content !important;
            display: flex !important;
            flex-direction: column !important;
            background-color: #121212 !important;
            height: 100vh !important;
            opacity: 1 !important;
            visibility: visible !important;
            pointer-events: auto !important;
            z-index: 20 !important;
        }
        
        /* Hide all auth screens */
        #auth-container, .login-container, #login-container {
            display: none !important;
            opacity: 0 !important;
            visibility: hidden !important;
            pointer-events: none !important;
            z-index: -1 !important;
        }
        
        /* Make sure elements are clickable */
        button, a, input, textarea {
            pointer-events: auto !important;
            cursor: pointer !important;
        }
        
        /* Force showing chat components */
        #messages-container, #message-input-area, #chat-header {
            display: flex !important;
            opacity: 1 !important;
            visibility: visible !important;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- Main App - Discord Layout -->
        <div id="chat-container" style="display: grid !important;">
            
            <!-- Left Sidebar -->
            <div id="left-sidebar" style="display: flex !important;">
                <!-- App Logo -->
                <div class="app-logo">
                    <img src="https://cdn.glitch.global/2ac452ce-4fe9-49bc-bef8-47241df17d07/default%20pic.png?v=1747408645553" alt="The Homies Chat" class="app-icon">
                    <span>The Homies Chat</span>
                </div>
                
                <!-- Main Navigation -->
                <div class="main-nav">
                    <button class="nav-button active" id="home-button" title="Home">
                        <i class="bi bi-house-fill"></i>
                        <span>Home</span>
                    </button>
                    <button class="nav-button" id="dm-button" title="Direct Messages">
                        <i class="bi bi-chat-fill"></i>
                        <span>DMs</span>
                    </button>
                </div>
                
                <!-- Channels Section -->
                <div id="channels-section">
                    <div class="section-header">
                        <span>CHANNELS</span>
                        <button id="add-channel-btn" class="btn-icon" title="Add Channel">
                            <i class="bi bi-plus-lg"></i>
                        </button>
                    </div>
                    <div id="channels-list" class="list-container">
                        <div class="list-item active" data-channel="general">
                            <i class="bi bi-hash"></i>
                            <span>general</span>
                        </div>
                        <div class="list-item" data-channel="announcements">
                            <i class="bi bi-hash"></i>
                            <span>announcements</span>
                        </div>
                        <div class="list-item" data-channel="memes">
                            <i class="bi bi-hash"></i>
                            <span>memes</span>
                        </div>
                    </div>
                </div>
                
                <!-- User Profile Area -->
                <div class="user-profile-area">
                    <div class="user-avatar">
                        <img src="https://cdn.glitch.global/2ac452ce-4fe9-49bc-bef8-47241df17d07/default%20pic.png?v=1744642336378" alt="Your Avatar">
                        <div class="user-status online"></div>
                    </div>
                    <div class="user-details">
                        <div class="user-name" id="current-user">Etherwolf</div>
                    </div>
                    <div class="user-controls">
                        <button class="user-control-button" id="settings-button" title="Settings">
                            <i class="bi bi-gear-fill"></i>
                        </button>
                        <button class="user-control-button" id="logout-btn" title="Logout">
                            <i class="bi bi-box-arrow-right"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Main Content Area (Right) -->
            <div id="main-content" style="display: flex !important;">
                <!-- Chat Header -->
                <div id="chat-header">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-hash me-2"></i>
                        <span class="fw-bold" id="chat-title">general</span>
                    </div>
                    <div class="header-controls">
                        <button class="header-button" id="video-call-button" title="Start Video Call">
                            <i class="bi bi-camera-video-fill"></i>
                        </button>
                    </div>
                </div>

                <!-- Messages Container -->
                <div id="messages-container">
                    <!-- Messages will be added here by JS -->
                    <div class="date-separator">
                        <span>Today</span>
                    </div>
                    <div class="system-message">
                        Welcome to the beginning of #general
                    </div>
                    <!-- Debug message -->
                    <div class="message">
                        <div class="message-avatar">
                            <img src="https://cdn.glitch.global/2ac452ce-4fe9-49bc-bef8-47241df17d07/default%20pic.png?v=1746110048911" alt="System">
                        </div>
                        <div class="message-content">
                            <div class="message-header">
                                <span class="message-author">System</span>
                                <span class="message-timestamp">Just now</span>
                            </div>
                            <div class="message-text">
                                Debug mode active. This is a special debug version to help fix display issues.
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Message Input Area -->
                <div id="message-input-area">
                    <div class="message-input-container">
                        <div class="input-wrapper">
                            <textarea id="message-input" placeholder="Message #general" rows="1"></textarea>
                        </div>
                        <div class="message-controls">
                            <button class="message-control-button" id="emoji-button" title="Add Emoji">
                                <i class="bi bi-emoji-smile"></i>
                            </button>
                            <button class="message-control-button" id="attach-file-button" title="Attach File">
                                <i class="bi bi-paperclip"></i>
                            </button>
                            <button id="send-button" title="Send Message">
                                <i class="bi bi-send-fill"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <!-- Third-party libraries -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

    <!-- Authentication scripts -->
    <script>
        // Check for existing authentication or perform login
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Debug mode active - checking authentication');
            
            // Display loading message while we check auth
            const body = document.body;
            const loadingOverlay = document.createElement('div');
            loadingOverlay.id = 'loading-overlay';
            loadingOverlay.style.position = 'fixed';
            loadingOverlay.style.top = '0';
            loadingOverlay.style.left = '0';
            loadingOverlay.style.width = '100%';
            loadingOverlay.style.height = '100%';
            loadingOverlay.style.backgroundColor = 'rgba(0,0,0,0.8)';
            loadingOverlay.style.display = 'flex';
            loadingOverlay.style.justifyContent = 'center';
            loadingOverlay.style.alignItems = 'center';
            loadingOverlay.style.zIndex = '9999';
            loadingOverlay.style.flexDirection = 'column';
            loadingOverlay.innerHTML = `
                <h2 style="color: white; margin-bottom: 20px;">Initializing Debug Mode...</h2>
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p id="loading-message" style="color: white; margin-top: 20px;">Checking authentication...</p>
            `;
            body.appendChild(loadingOverlay);
            
            // Function to update loading message
            function updateLoadingMessage(message) {
                document.getElementById('loading-message').textContent = message;
            }
            
            // Check for existing auth in localStorage
            const storedUser = localStorage.getItem('user');
            const authToken = localStorage.getItem('auth_token');
            
            if (storedUser && authToken) {
                try {
                    const user = JSON.parse(storedUser);
                    console.log('Found stored authentication', user.username);
                    updateLoadingMessage(`Found stored authentication for ${user.username}`);
                    
                    // Create socket connection with auth
                    window.socket = io({
                        auth: {
                            token: authToken,
                            userData: user
                        },
                        query: {
                            token: authToken,
                            userId: user.id || '',
                            username: user.username || ''
                        }
                    });
                    
                    // Listen for socket connection
                    window.socket.on('connect', function() {
                        console.log('Socket connected, registering session');
                        updateLoadingMessage('Socket connected, initializing interface...');
                        
                        // Register session
                        window.socket.emit('register-session', user);
                        
                        // Show the chat interface
                        setTimeout(() => {
                            initDebugInterface(user);
                            loadingOverlay.remove();
                        }, 1000);
                    });
                    
                    // Handle connection error
                    window.socket.on('connect_error', function(error) {
                        console.error('Socket connection error:', error);
                        updateLoadingMessage('Connection error, falling back to debug mode...');
                        
                        // Show interface anyway after delay
                        setTimeout(() => {
                            initDebugInterface(user);
                            loadingOverlay.remove();
                        }, 2000);
                    });
                } catch (e) {
                    console.error('Error parsing stored user:', e);
                    showLoginForm();
                }
            } else {
                // No stored authentication, show login form
                updateLoadingMessage('No stored authentication, please log in');
                setTimeout(() => {
                    showLoginForm();
                }, 1000);
            }
            
            // Function to show login form
            function showLoginForm() {
                loadingOverlay.remove();
                
                // Create login form overlay
                const loginOverlay = document.createElement('div');
                loginOverlay.id = 'login-overlay';
                loginOverlay.style.position = 'fixed';
                loginOverlay.style.top = '0';
                loginOverlay.style.left = '0';
                loginOverlay.style.width = '100%';
                loginOverlay.style.height = '100%';
                loginOverlay.style.backgroundColor = 'rgba(0,0,0,0.8)';
                loginOverlay.style.display = 'flex';
                loginOverlay.style.justifyContent = 'center';
                loginOverlay.style.alignItems = 'center';
                loginOverlay.style.zIndex = '9999';
                
                loginOverlay.innerHTML = `
                    <div class="card" style="width: 400px;">
                        <div class="card-header bg-primary text-white text-center">
                            <h4>Debug Mode Login</h4>
                        </div>
                        <div class="card-body">
                            <form id="debug-login-form">
                                <div class="mb-3">
                                    <label for="username" class="form-label">Username</label>
                                    <input type="text" class="form-control" id="username" value="Etherwolf">
                                </div>
                                <div class="mb-3">
                                    <label for="password" class="form-label">Password</label>
                                    <input type="password" class="form-control" id="password" value="password">
                                </div>
                                <div id="login-error" class="alert alert-danger d-none"></div>
                                <button type="submit" class="btn btn-primary w-100">Login</button>
                            </form>
                        </div>
                    </div>
                `;
                
                body.appendChild(loginOverlay);
                
                // Set up login form submission
                document.getElementById('debug-login-form').addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const username = document.getElementById('username').value;
                    const password = document.getElementById('password').value;
                    
                    if (!username || !password) {
                        showLoginError('Username and password are required');
                        return;
                    }
                    
                    // Show loading message
                    document.querySelector('#debug-login-form button').innerHTML = `
                        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                        Logging in...
                    `;
                    
                    // Attempt login
                    fetch('/api/auth/signin', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ username, password }),
                        credentials: 'include'
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.ok && data.user) {
                            // Store authentication
                            localStorage.setItem('user', JSON.stringify(data.user));
                            localStorage.setItem('auth_token', data.token || '');
                            
                            // Create socket connection
                            window.socket = io({
                                auth: {
                                    token: data.token || '',
                                    userData: data.user
                                },
                                query: {
                                    token: data.token || '',
                                    userId: data.user.id || '',
                                    username: data.user.username || ''
                                }
                            });
                            
                            // Register session
                            window.socket.emit('register-session', data.user);
                            
                            // Remove login overlay and show interface
                            loginOverlay.remove();
                            initDebugInterface(data.user);
                        } else {
                            showLoginError(data.error || 'Login failed');
                            document.querySelector('#debug-login-form button').textContent = 'Login';
                        }
                    })
                    .catch(error => {
                        console.error('Login error:', error);
                        showLoginError('An error occurred during login');
                        document.querySelector('#debug-login-form button').textContent = 'Login';
                    });
                });
                
                // Helper to show login errors
                function showLoginError(message) {
                    const errorElement = document.getElementById('login-error');
                    errorElement.textContent = message;
                    errorElement.classList.remove('d-none');
                }
            }
        });
        
        // Function to initialize the debug interface
        function initDebugInterface(user) {
            console.log('Initializing debug interface for user:', user.username);
            
            // Make sure chat container is visible
            const chatContainer = document.getElementById('chat-container');
            if (chatContainer) {
                chatContainer.style.display = 'grid';
                chatContainer.style.opacity = '1';
                chatContainer.style.visibility = 'visible';
            }
            
            // Update user display
            const currentUserEl = document.getElementById('current-user');
            if (currentUserEl && user.username) {
                currentUserEl.textContent = user.username;
            }
            
            // Setup basic click handlers
            const channelItems = document.querySelectorAll('#channels-list .list-item');
            channelItems.forEach(item => {
                item.addEventListener('click', function() {
                    // Update active channel UI
                    channelItems.forEach(chan => chan.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Update chat title
                    const channelName = this.getAttribute('data-channel');
                    document.getElementById('chat-title').textContent = channelName;
                    
                    // Update message input placeholder
                    document.getElementById('message-input').placeholder = `Message #${channelName}`;
                });
            });
            
            // Setup send button
            const sendButton = document.getElementById('send-button');
            const messageInput = document.getElementById('message-input');
            const messagesContainer = document.getElementById('messages-container');
            
            if (sendButton && messageInput && messagesContainer) {
                sendButton.addEventListener('click', function() {
                    const messageText = messageInput.value.trim();
                    if (messageText) {
                        // Create simple message element
                        const messageEl = document.createElement('div');
                        messageEl.className = 'message own-message';
                        messageEl.innerHTML = `
                            <div class="message-avatar">
                                <img src="https://cdn.glitch.global/2ac452ce-4fe9-49bc-bef8-47241df17d07/default%20pic.png?v=1746110048911" alt="You">
                            </div>
                            <div class="message-content">
                                <div class="message-header">
                                    <span class="message-author">${user.username}</span>
                                    <span class="message-timestamp">Just now</span>
                                </div>
                                <div class="message-text">
                                    ${messageText}
                                </div>
                            </div>
                        `;
                        
                        messagesContainer.appendChild(messageEl);
                        messageInput.value = '';
                        
                        // Scroll to bottom
                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                        
                        // If socket is connected, send message
                        if (window.socket && window.socket.connected) {
                            const activeChannel = document.querySelector('#channels-list .list-item.active');
                            const channelName = activeChannel ? activeChannel.getAttribute('data-channel') : 'general';
                            
                            window.socket.emit('message', {
                                content: messageText,
                                channel: '#' + channelName,
                                sender: user.username,
                                timestamp: new Date().toISOString()
                            });
                        }
                    }
                });
                
                // Allow Enter key to send message
                messageInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendButton.click();
                    }
                });
            }
            
            // Set up logout button
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', function() {
                    localStorage.removeItem('user');
                    localStorage.removeItem('auth_token');
                    window.location.reload();
                });
            }
        }
    </script>
</body>
</html>
